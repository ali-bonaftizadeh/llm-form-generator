<?xml version="1.0" encoding="UTF-8" ?>

<!--
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~       http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.activiti.engine.impl.persistence.entity.TaskEntityImpl">
  <!-- TASK SELECT COUNT -->
  <select id="selectTaskCountByQueryCriteria" parameterType="org.activiti.engine.impl.TaskQueryImpl" resultType="long">
    <choose>
      <when test="_databaseId == 'mariadb'">
        <!--
          mariadb has performance penalty when using "withoutJoins" sql scripts
        -->
        <include refid="withJoins_selectTaskCountByQueryCriteria"/>
      </when>
      <otherwise>
        <!--<include refid="withoutJoins_selectTaskCountByQueryCriteria"/>-->
        <include refid="optimised_v2_selectTaskCountByQueryCriteria"/>
      </otherwise>
    </choose>
  </select>

  <sql id="withJoins_selectTaskCountByQueryCriteria">
    select count(distinct RES.ID_)
    <include refid="withJoins_selectTaskByQueryCriteriaSql"/>
  </sql>
  <sql id="withoutJoins_selectTaskCountByQueryCriteria">
    select count(SUB.ID_)
    <include refid="withoutJoins_selectTaskByQueryCriteriaSql"/>
  </sql>


  <!--
  Example of a count query (SqlServer):
    SELECT COUNT(res.id_)
    FROM act_ru_task res
    LEFT JOIN act_re_procdef deploy_p_or0 ON res.proc_def_id_ = deploy_p_or0.id_
    LEFT JOIN (
        SELECT task_id_
        FROM act_ru_identitylink
        WHERE (user_id_ = '4' OR (type_ = 'participant' AND group_id_ IN ('1', '2')))
    ) i_or_user_group ON i_or_user_group.task_id_ = res.id_
    WHERE (
        deploy_p_or0.deployment_id_ IN ('3', '40845001')
        OR res.category_ = '1'
    )
    AND (
        i_or_user_group.task_id_ IS NOT NULL
        OR res.assignee_ = '4'
        OR res.owner_ = '4'
    )
  -->
  <sql id="optimised_v2_selectTaskCountByQueryCriteria">
    select count(res.id_)
    from ${prefix}act_ru_task res
    <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
      <if test="orQueryObject.deploymentIds != null &amp;&amp; orQueryObject.deploymentIds.size() &gt; 0">
        left join ${prefix}act_re_procdef deploy_p_or${orIndex} on res.proc_def_id_ = deploy_p_or${orIndex}.id_
      </if>
      <if test="orQueryObject.involvedUser != null || (orQueryObject.involvedGroups != null &amp;&amp; orQueryObject.involvedGroups.size() &gt; 0)">
        left join (
          select task_id_
          from ${prefix}act_ru_identitylink
          where (
            <if test="orQueryObject.involvedUser != null">
              user_id_ = #{orQueryObject.involvedUser}
            </if>
            <if test="orQueryObject.involvedGroups != null &amp;&amp; orQueryObject.involvedGroups.size() &gt; 0">
              or (
                type_ = 'participant'
                and group_id_ IN
                <foreach item="group" index="index" collection="orQueryObject.involvedGroups" open="(" separator="," close=")">
                  #{group}
                </foreach>
              )
            </if>
          )
        ) i_or_user_group ON i_or_user_group.task_id_ = res.id_
      </if>
    </foreach>
    where
      (
      <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
        <if test="orQueryObject.deploymentIds != null &amp;&amp; orQueryObject.deploymentIds.size() &gt; 0">
          deploy_p_or${orIndex}.deployment_id_ in
          <foreach item="deployment" index="index" collection="orQueryObject.deploymentIds" open="(" separator="," close=")">
            #{deployment}
          </foreach>
        </if>
        <if test="orQueryObject.category != null">
          or res.category_ = #{orQueryObject.category}
        </if>
      </foreach>
      )
      <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
            <if test="orQueryObject.involvedUser != null">
              and (
                i_or_user_group.task_id_ is not null
                or res.assignee_ = #{orQueryObject.involvedUser}
                or res.owner_ = #{orQueryObject.involvedUser}
              )
            </if>
      </foreach>
  </sql>

  <!-- other SQL queries are in Task-Select.xml file -->
</mapper>
