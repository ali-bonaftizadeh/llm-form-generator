<?xml version="1.0" encoding="UTF-8" ?>

<!--
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~       http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.activiti.engine.impl.persistence.entity.TaskEntityImpl">
  <!-- TASK SELECT COUNT -->
  <select id="selectTaskCountByQueryCriteria" parameterType="org.activiti.engine.impl.TaskQueryImpl" resultType="long">
    <choose>
      <when test="_databaseId == 'mariadb'">
        <!--
          mariadb has performance penalty when using "withoutJoins" sql scripts
        -->
        <include refid="withJoins_selectTaskCountByQueryCriteria"/>
      </when>
      <otherwise>
        <!--<include refid="withoutJoins_selectTaskCountByQueryCriteria"/>-->
        <include refid="optimised_selectTaskCountByQueryCriteria"/>
      </otherwise>
    </choose>
  </select>

  <sql id="withJoins_selectTaskCountByQueryCriteria">
    select count(distinct RES.ID_)
    <include refid="withJoins_selectTaskByQueryCriteriaSql"/>
  </sql>
  <sql id="withoutJoins_selectTaskCountByQueryCriteria">
    select count(SUB.ID_)
    <include refid="withoutJoins_selectTaskByQueryCriteriaSql"/>
  </sql>


  <!--
  Example of a count query (SqlServer):
    EXEC sp_executesql N'
    SELECT COUNT(RES.ID_)
    FROM ACT_RU_TASK RES
    LEFT JOIN ACT_RE_PROCDEF DEPLOY_P_OR0 ON RES.PROC_DEF_ID_ = DEPLOY_P_OR0.ID_
    LEFT JOIN ACT_RU_IDENTITYLINK LINK ON LINK.TASK_ID_ = RES.ID_ AND LINK.USER_ID_ = @P3
    LEFT JOIN ACT_RU_IDENTITYLINK I_OR1 ON I_OR1.TASK_ID_ = RES.ID_ AND I_OR1.TYPE_ = ''participant'' AND I_OR1.GROUP_ID_ IN (@P6, @P7)
    WHERE
        (
            DEPLOY_P_OR0.DEPLOYMENT_ID_ IN (@P0, @P1)
            OR RES.CATEGORY_ = @P2
        )
        AND (
            LINK.USER_ID_ IS NOT NULL
            OR RES.ASSIGNEE_ = @P4
            OR RES.OWNER_ = @P5
            OR I_OR1.GROUP_ID_ IS NOT NULL
        )',
    N'@P0 nvarchar(4000), @P1 nvarchar(4000), @P2 nvarchar(4000), @P3 nvarchar(4000), @P4 nvarchar(4000), @P5 nvarchar(4000), @P6 nvarchar(4000), @P7 nvarchar(4000)',
    N'3', N'40845001', N'1', N'2', N'2', N'2', N'1', N'2'
  -->
  <sql id="optimised_selectTaskCountByQueryCriteria">
    select count(res.id_)
    from ${prefix}act_ru_task res
    <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
      <if test="orQueryObject.deploymentIds != null &amp;&amp; orQueryObject.deploymentIds.size() &gt; 0">
        left join ${prefix}act_re_procdef deploy_p_or${orIndex} on res.proc_def_id_ = deploy_p_or${orIndex}.id_
      </if>
      <if test="orQueryObject.involvedUser != null">
        <!-- this is weird, we're handling an "orQuery" but the table-alias is just "link", should be something like i_or${orIndex} -->
        left join ${prefix}act_ru_identitylink i_or${orIndex}_user on
          i_or${orIndex}_user.task_id_= res.id_ and
          i_or${orIndex}_user.user_id_ = #{orQueryObject.involvedUser}
      </if>
      <if test="orQueryObject.involvedGroups != null &amp;&amp; orQueryObject.involvedGroups.size() &gt; 0">
        left join ${prefix}act_ru_identitylink i_or${orIndex}_group on
          i_or${orIndex}_group.task_id_ = res.id_ and
          i_or${orIndex}_group.type_ = 'participant' and
          i_or${orIndex}_group.group_id_ in
          <foreach item="group" index="index" collection="orQueryObject.involvedGroups" open="(" separator="," close=")">
            #{group}
          </foreach>
      </if>
    </foreach>
    where
      <!-- I've got doubts regarding this "trim" -->
      <trim prefix="(" prefixOverrides="or" suffix=")">
        <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
          <if test="orQueryObject.deploymentIds != null &amp;&amp; orQueryObject.deploymentIds.size() &gt; 0">
            deploy_p_or${orIndex}.deployment_id_ in
            <foreach item="deployment" index="index" collection="orQueryObject.deploymentIds" open="(" separator="," close=")">
              #{deployment}
            </foreach>
          </if>
          <if test="orQueryObject.category != null">
            or res.category_ = #{orQueryObject.category}
          </if>
        </foreach>
      </trim>
      and (
        <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
          <if test="orQueryObject.involvedUser != null">
            i_or${orIndex}_user.user_id_ is not null
            or res.assignee_ = #{orQueryObject.involvedUser}
            or res.owner_ = #{orQueryObject.involvedUser}
          </if>
          <if test="orQueryObject.involvedGroups != null &amp;&amp; orQueryObject.involvedGroups.size() &gt; 0">
            or i_or${orIndex}_group.group_id_ is not null
          </if>
        </foreach>
      )

  </sql>

  <!-- other SQL queries are in Task-Select.xml file -->
</mapper>
