<?xml version="1.0" encoding="UTF-8" ?>

<!--
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~       http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.activiti.engine.impl.persistence.entity.HistoricProcessInstanceEntityImpl">

  <!-- entry points -->

  <sql id="202504_selectColumnsSql">
    <!-- constants -->
    <bind name="PROCESS_VARIABLES_COLUMNS" value="',VAR.ID_ as VAR_ID_,
    VAR.NAME_ as VAR_NAME_,
    VAR.VAR_TYPE_ as VAR_TYPE_,
    VAR.REV_ as VAR_REV_,
    VAR.PROC_INST_ID_ as VAR_PROC_INST_ID_,
    VAR.EXECUTION_ID_ as VAR_EXECUTION_ID_,
    VAR.TASK_ID_ as VAR_TASK_ID_,
    VAR.BYTEARRAY_ID_ as VAR_BYTEARRAY_ID_,
    VAR.DOUBLE_ as VAR_DOUBLE_,
    VAR.TEXT_ as VAR_TEXT_,
    VAR.TEXT2_ as VAR_TEXT2_,
    VAR.LAST_UPDATED_TIME_ as VAR_LAST_UPDATED_TIME_,
    VAR.LONG_ as VAR_LONG_'"/>
    <bind name="columns" value="'RES.*, DEF.KEY_ as PROC_DEF_KEY_, DEF.NAME_ as PROC_DEF_NAME_, DEF.VERSION_ as PROC_DEF_VERSION_, DEF.DEPLOYMENT_ID_ as DEPLOYMENT_ID_'"/>

    <!-- default distinctMode is to not have distinct -->
    <bind name="distinctMode" value="''"/>
    <bind name="processVariablesColumns" value="''"/>

    <!-- situations where we need to have additional columns for process variables -->
    <if test="includeProcessVariables">
        <bind name="processVariablesColumns" value="PROCESS_VARIABLES_COLUMNS"/>
    </if>

    <!-- situations where distinct is necessary -->
    <if test="withException">
      <bind name="distinctMode" value="'distinct'"/>
    </if>
    <!-- because we can have the same variable on the same process-instance but on different executions, we need to have distinct -->
    <if test="queryVariableValues != null &amp;&amp; queryVariableValues.size() &gt; 0">
      <bind name="distinctMode" value="'distinct'"/>
    </if>
    <if test="orQueryObjects != null &amp;&amp; orQueryObjects.size() &gt; 0">
      <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
        <if test="orQueryObject.withException">
          <bind name="distinctMode" value="'distinct'"/>
        </if>
        <if test="orQueryObject.queryVariableValues != null &amp;&amp; orQueryObject.queryVariableValues.size() &gt; 0">
          <bind name="distinctMode" value="'distinct'"/>
        </if>
      </foreach>
    </if>
    <if test="${isCount} &amp;&amp; includeProcessVariables">
      <bind name="distinctMode" value="'distinct'"/>
    </if>

    <choose>
      <!-- if it's a count, only "RES.ID_" is needed -->
      <when test="${isCount} == true">
        select ${distinctMode} RES.ID_ as uniqueId
      </when>
      <otherwise>
        <choose>
          <!-- if it's not a count and there's a distinct, we need to remove duplicated based on RES.ID_ -->
          <when test="distinctMode == 'distinct'">
            select RES.* ${202504_limitBetween}
            from (
              select ${distinctMode} RES.ID_ as uniqueId, ${columns} ${processVariablesColumns}
          </when>
          <!-- if it's not a count nor distinct, we don't need explicit RES.ID_ -->
          <otherwise>
            select RES.* ${202504_limitBetween}
            from (
              select ${columns} ${processVariablesColumns}
          </otherwise>
        </choose>
      </otherwise>
    </choose>
  </sql>


  <sql id="202504_selectHistoricProcessInstancesByQueryCriteria">
    ${202504_limitBefore}
    <include refid="202504_selectHistoricProcessInstancesByQueryCriteriaSql">
      <property name="isCount" value="false"/>
    </include>
    <choose>
      <when test="'${202504_limitAfter}' != null and _databaseId != 'mssql' and _databaseId != 'oracle'">
        ${orderBy}
        ${202504_limitAfter}
      </when>
      <otherwise>
        ${202504_limitAfter}
        ORDER BY rnk
      </otherwise>
    </choose>
  </sql>

  <sql id="202504_selectHistoricProcessInstancesByQueryCriteriaSql">
    <include refid="202504_selectColumnsSql">
      <property name="isCount" value="${isCount}"/>
    </include>
    from ${prefix}ACT_HI_PROCINST RES
      <include refid="202504_commonSelectHistoricProcessInstancesByQueryCriteriaSql"/>
  </sql>





</mapper>
